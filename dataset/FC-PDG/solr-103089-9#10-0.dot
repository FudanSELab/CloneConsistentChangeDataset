digraph {
51 [style = filled, label = "i < nReadThreads@@@122@@@['0', '0', '1']", fillcolor = white, shape = diamond image = "AAA0AAABBB3BBB"];
18 [style = filled, label = "verbose(\"operations=\",operations)@@@27@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
59 [style = filled, label = "threads.add(thread)@@@119@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
58 [style = filled, label = "i++@@@123@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
15 [style = filled, label = "initModel(ndocs)@@@17@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
25 [style = filled, label = "threads.add(thread)@@@180@@@['1', '0', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
27 [style = filled, label = "final int filteredGetPercent = random().nextInt(random().nextInt(20) + 1)@@@11@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
35 [style = filled, label = "verbose(\"nWriteThreads=\",nWriteThreads)@@@23@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
21 [style = filled, label = "i < nWriteThreads@@@21@@@['1', '1', '1']", fillcolor = white, shape = diamond image = "AAA0AAABBB1BBB"];
36 [style = filled, label = "final int maxConcurrentCommits = nWriteThreads@@@13@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
41 [style = filled, label = "i++@@@174@@@['0', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB2BBB"];
9 [style = filled, label = "threads.add(thread)@@@241@@@['1', '0', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
19 [style = filled, label = "final int softCommitPercent = 30 + random().nextInt(75)@@@6@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
28 [style = filled, label = "final int percentRealtimeQuery = 60@@@15@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
43 [style = filled, label = "int i = 0@@@172@@@['0', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB2BBB"];
22 [style = filled, label = "verbose(\"maxConcurrentCommits=\",maxConcurrentCommits)@@@26@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
23 [style = filled, label = "final int optimisticCorrectPercent = 25 + random().nextInt(70)@@@10@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
37 [style = filled, label = "thread.join()@@@247@@@['1', '0', '0']", fillcolor = lightgray, shape = ellipse image = "AAA0AAABBB1BBB"];
1 [style = filled, label = "verbose(\"nReadThreads=\",nReadThreads)@@@24@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
31 [style = filled, label = "int nReadThreads = 5 + random().nextInt(25)@@@16@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
8 [style = filled, label = "testStressGetRealtime['1', '0', '0']", fillcolor = lightgray, shape = diamond image = "AAA0AAABBB1BBB"];
2 [style = filled, label = "final int deletePercent = 4 + random().nextInt(25)@@@7@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
6 [style = filled, label = "int i = 0@@@182@@@['1', '0', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
48 [style = filled, label = "threads.add(thread)@@@170@@@['0', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB2BBB"];
7 [style = filled, label = "final AtomicInteger numCommitting = new AtomicInteger()@@@18@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
17 [style = filled, label = "thread.start()@@@244@@@['1', '0', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
47 [style = filled, label = "testStressGetRealtime['0', '1', '0']", fillcolor = lightgray, shape = diamond image = "AAA0AAABBB2BBB"];
24 [style = filled, label = "final int commitPercent = 5 + random().nextInt(20)@@@5@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
5 [style = filled, label = "i++@@@184@@@['1', '0', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
56 [style = filled, label = "thread.start()@@@176@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
40 [style = filled, label = "final int optimisticPercent = 1 + random().nextInt(50)@@@9@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
30 [style = filled, label = "int i = 0@@@20@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
42 [style = filled, label = "thread.join()@@@237@@@['0', '1', '0']", fillcolor = lightgray, shape = ellipse image = "AAA0AAABBB2BBB"];
34 [style = filled, label = "int nWriteThreads = 5 + random().nextInt(25)@@@12@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
53 [style = filled, label = "Thread thread = new Thread(\"READER\" + i){@Override public void run(){try {while (operations.decrementAndGet() >= 0) {int id = rand.nextInt(100) < 25? lastId: rand.nextInt(ndocs)boolean realTime = rand.nextInt(100) < percentRealtimeQueryDocInfo infoif (realTime) {info = model.get(id)}{synchronized (globalLock) {info = committedModel.get(id)}}if (VERBOSE) {verbose(\"querying id\",id)}SolrQueryRequest sreqif (realTime) {sreq = req(\"wt\",\"json\",\"qt\",\"/get\",\"ids\",Integer.toString(id))}{sreq = req(\"wt\",\"json\",\"q\",\"id:\" + Integer.toString(id),\"omitHeader\",\"true\")}String response = h.query(sreq)Map rsp = (Map)ObjectBuilder.fromJSON(response)List doclist = (List)(((Map)rsp.get(\"response\")).get(\"docs\"))if (doclist.size() == 0) {}{assertEquals(1,doclist.size())long foundVal = (Long)(((Map)doclist.get(0)).get(FIELD))long foundVer = (Long)(((Map)doclist.get(0)).get(\"_version_\"))if (foundVer < Math.abs(info.version) || (foundVer == info.version && foundVal != info.val)) {verbose(\"ERROR, id=\",id,\"found=\",response,\"model\",info)assertTrue(false)}}}}catch (Throwable e) }}@@@124@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
50 [style = filled, label = "testStressGetRealtimeVersions['0', '0', '1']", fillcolor = lightgray, shape = diamond image = "AAA0AAABBB3BBB"];
29 [style = filled, label = "verbose(\"deletePercent=\",deletePercent)@@@20@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
44 [style = filled, label = "i < nReadThreads@@@173@@@['0', '1', '0']", fillcolor = white, shape = diamond image = "AAA0AAABBB2BBB"];
39 [style = filled, label = "final int deleteByQueryPercent = 1 + random().nextInt(5)@@@8@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
46 [style = filled, label = "thread.start()@@@234@@@['0', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB2BBB"];
60 [style = filled, label = "thread.join()@@@179@@@['0', '0', '1']", fillcolor = lightgray, shape = ellipse image = "AAA0AAABBB3BBB"];
33 [style = filled, label = "Thread thread = new Thread(\"READER\" + i){@Override public void run(){try {while (operations.decrementAndGet() >= 0) {int id = rand.nextInt(100) < 25? lastId: rand.nextInt(ndocs)boolean realTime = rand.nextInt(100) < percentRealtimeQueryDocInfo infoif (realTime) {info = model.get(id)}{synchronized (this) {info = committedModel.get(id)}}if (VERBOSE) {verbose(\"querying id\",id)}boolean filteredOut = falseSolrQueryRequest sreqif (realTime) {ModifiableSolrParams p = params(\"wt\",\"json\",\"qt\",\"/get\",\"ids\",Integer.toString(id))if (rand.nextInt(100) < filteredGetPercent) {int idToFilter = rand.nextBoolean()? id: rand.nextInt(ndocs)filteredOut = idToFilter != idp.add(\"fq\",\"id:\" + idToFilter)}sreq = req(p)}{sreq = req(\"wt\",\"json\",\"q\",\"id:\" + Integer.toString(id),\"omitHeader\",\"true\")}String response = h.query(sreq)Map rsp = (Map)ObjectBuilder.fromJSON(response)List doclist = (List)(((Map)rsp.get(\"response\")).get(\"docs\"))if (doclist.size() == 0) {}{assertEquals(1,doclist.size())long foundVal = (Long)(((Map)doclist.get(0)).get(FIELD))long foundVer = (Long)(((Map)doclist.get(0)).get(\"_version_\"))if (filteredOut || foundVal < Math.abs(info.val) || (foundVer == info.version && foundVal != info.val)) {verbose(\"ERROR, id=\",id,\"found=\",response,\"model\",info)assertTrue(false)}}}}catch (Throwable e) }}@@@185@@@['1', '0', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
14 [style = filled, label = "verbose(\"deleteByQueryPercent=\",deleteByQueryPercent)@@@21@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
3 [style = filled, label = "Thread thread = new Thread(\"WRITER\" + i){@Override public void run(){try {while (operations.get() > 0) {int oper = rand.nextInt(100)if (oper < commitPercent) {if (numCommitting.incrementAndGet() <= maxConcurrentCommits) {Map<Integer,DocInfo> newCommittedModellong versionsynchronized (globalLock) {newCommittedModel = new HashMap<>(model)version = snapshotCount++}if (rand.nextInt(100) < softCommitPercent) {verbose(\"softCommit start\")assertU(TestHarness.commit(\"softCommit\",\"true\"))verbose(\"softCommit end\")}{verbose(\"hardCommit start\")assertU(commit())verbose(\"hardCommit end\")}synchronized (globalLock) {if (version >= committedModelClock) {if (VERBOSE) {verbose(\"installing new committedModel version=\" + committedModelClock)}committedModel = newCommittedModelcommittedModelClock = version}}}numCommitting.decrementAndGet()continue}int id = rand.nextInt(ndocs)Object sync = syncArr(id(boolean before = rand.nextBoolean()if (before) {lastId = id}DocInfo info = model.get(id)long val = info.vallong nextVal = Math.abs(val) + 1if (oper < commitPercent + deletePercent) {verbose(\"deleting id\",id,\"val=\",nextVal)Long version = deleteAndGetVersion(Integer.toString(id),null)assertTrue(version < 0)synchronized (model) {DocInfo currInfo = model.get(id)if (Math.abs(version) > Math.abs(currInfo.version)) {model.put(id,new DocInfo(version,-nextVal))}}verbose(\"deleting id\",id,\"val=\",nextVal,\"DONE\")}if (oper < commitPercent + deletePercent + deleteByQueryPercent) {verbose(\"deleteByQyery id\",id,\"val=\",nextVal)Long version = deleteByQueryAndGetVersion(\"id:\" + Integer.toString(id),null)assertTrue(version < 0)synchronized (model) {DocInfo currInfo = model.get(id)if (Math.abs(version) > Math.abs(currInfo.version)) {model.put(id,new DocInfo(version,-nextVal))}}verbose(\"deleteByQyery id\",id,\"val=\",nextVal,\"DONE\")}{verbose(\"adding id\",id,\"val=\",nextVal)Long version = addAndGetVersion(sdoc(\"id\",Integer.toString(id),FIELD,Long.toString(nextVal)),null)assertTrue(version > 0)synchronized (model) {DocInfo currInfo = model.get(id)if (version > currInfo.version) {model.put(id,new DocInfo(version,nextVal))}}if (VERBOSE) {verbose(\"adding id\",id,\"val=\",nextVal,\"DONE\")}}if (!before) {lastId = id}}}catch (Throwable e) }}@@@23@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
52 [style = filled, label = "int i = 0@@@121@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
13 [style = filled, label = "verbose(\"ndocs=\",ndocs)@@@22@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
38 [style = filled, label = "clearIndex()@@@3@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
11 [style = filled, label = "i++@@@22@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
55 [style = filled, label = "final int percentRealtimeQuery = 75@@@14@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
57 [style = filled, label = "final int deleteByQueryPercent = 1 + random().nextInt(5)@@@8@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
16 [style = filled, label = "List<Thread> threads = new ArrayList<>()@@@19@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
45 [style = filled, label = "threads.add(thread)@@@231@@@['0', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB2BBB"];
12 [style = filled, label = "verbose(\"commitPercent=\",commitPercent)@@@18@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
49 [style = filled, label = "Thread thread = new Thread(\"READER\" + i){@Override public void run(){try {while (operations.decrementAndGet() >= 0) {int id = rand.nextInt(100) < 25? lastId: rand.nextInt(ndocs)boolean realTime = rand.nextInt(100) < percentRealtimeQueryDocInfo infoif (realTime) {info = model.get(id)}{synchronized (this) {info = committedModel.get(id)}}if (VERBOSE) {verbose(\"querying id\",id)}boolean filteredOut = falseSolrQueryRequest sreqif (realTime) {ModifiableSolrParams p = params(\"wt\",\"json\",\"qt\",\"/get\",\"ids\",Integer.toString(id))if (rand.nextInt(100) < filteredGetPercent) {int idToFilter = rand.nextBoolean()? id: rand.nextInt(ndocs)filteredOut = idToFilter != idp.add(\"fq\",\"id:\" + idToFilter)}sreq = req(p)}{sreq = req(\"wt\",\"json\",\"q\",\"id:\" + Integer.toString(id),\"omitHeader\",\"true\")}String response = h.query(sreq)Map rsp = (Map)ObjectBuilder.fromJSON(response)List doclist = (List)(((Map)rsp.get(\"response\")).get(\"docs\"))if (doclist.size() == 0) {}{assertEquals(1,doclist.size())long foundVal = (Long)(((Map)doclist.get(0)).get(FIELD))long foundVer = (Long)(((Map)doclist.get(0)).get(\"_version_\"))if (filteredOut || foundVal < Math.abs(info.val) || (foundVer == info.version && foundVal != info.val)) {verbose(\"ERROR, id=\",id,\"found=\",response,\"model\",info)assertTrue(false)}}}}catch (Throwable e) }}@@@175@@@['0', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB2BBB"];
26 [style = filled, label = "i < nReadThreads@@@183@@@['1', '0', '0']", fillcolor = white, shape = diamond image = "AAA0AAABBB1BBB"];
32 [style = filled, label = "final int ndocs = 5 + (random().nextBoolean()? random().nextInt(25): random().nextInt(200))@@@11@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
0 [style = filled, label = "verbose(\"softCommitPercent=\",softCommitPercent)@@@19@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
54 [style = filled, label = "threads.add(thread)@@@173@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
10 [style = filled, label = "final AtomicLong operations = new AtomicLong(50000)@@@15@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
4 [style = filled, label = "verbose(\"percentRealtimeQuery=\",percentRealtimeQuery)@@@25@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
20 [style = filled, label = "assertU(commit())@@@4@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
55->53 [style = solid, label="percentRealtimeQuery"];
27->49 [style = solid, label="filteredGetPercent"];
58->51 [style = solid, label="i"];
21->3 [style = bold, label=""];
26->17 [style = bold, label=""];
23->32 [style = bold, label=""];
30->21 [style = bold, label=""];
28->49 [style = solid, label="percentRealtimeQuery"];
51->58 [style = dotted, label="true"];
32->53 [style = solid, label="ndocs"];
3->59 [style = solid, label="thread"];
54->58 [style = bold, label=""];
39->57 [style = dashed, label="0"];
27->32 [style = bold, label=""];
45->41 [style = bold, label=""];
4->22 [style = bold, label=""];
21->48 [style = dotted, label="true"];
43->44 [style = solid, label="i"];
21->43 [style = bold, label=""];
44->49 [style = bold, label=""];
44->49 [style = dotted, label="true"];
3->25 [style = bold, label=""];
36->28 [style = bold, label=""];
44->45 [style = dotted, label="true"];
33->9 [style = bold, label=""];
21->11 [style = dotted, label="true"];
23->3 [style = solid, label="optimisticCorrectPercent"];
33->9 [style = solid, label="thread"];
43->44 [style = bold, label=""];
34->21 [style = solid, label="nWriteThreads"];
24->3 [style = solid, label="commitPercent"];
11->21 [style = solid, label="i"];
23->27 [style = bold, label=""];
12->0 [style = bold, label=""];
26->9 [style = dotted, label="true"];
31->26 [style = solid, label="nReadThreads"];
44->46 [style = bold, label=""];
40->3 [style = solid, label="optimisticPercent"];
27->33 [style = solid, label="filteredGetPercent"];
41->44 [style = bold, label=""];
3->48 [style = solid, label="thread"];
0->29 [style = bold, label=""];
7->16 [style = bold, label=""];
14->13 [style = bold, label=""];
3->59 [style = bold, label=""];
6->33 [style = solid, label="i"];
15->7 [style = bold, label=""];
21->52 [style = bold, label=""];
13->35 [style = bold, label=""];
19->0 [style = solid, label="softCommitPercent"];
35->1 [style = bold, label=""];
6->5 [style = solid, label="i"];
52->51 [style = bold, label=""];
26->5 [style = dotted, label="true"];
36->22 [style = solid, label="maxConcurrentCommits"];
47->38 [style = bold, label=""];
53->54 [style = solid, label="thread"];
55->10 [style = bold, label=""];
1->4 [style = bold, label=""];
32->34 [style = bold, label=""];
28->10 [style = bold, label=""];
19->2 [style = bold, label=""];
29->14 [style = bold, label=""];
51->56 [style = bold, label=""];
6->26 [style = solid, label="i"];
31->15 [style = bold, label=""];
21->6 [style = bold, label=""];
21->25 [style = dotted, label="true"];
51->53 [style = dotted, label="true"];
18->15 [style = bold, label=""];
57->3 [style = solid, label="deleteByQueryPercent"];
53->54 [style = bold, label=""];
32->49 [style = solid, label="ndocs"];
49->45 [style = bold, label=""];
2->39 [style = bold, label=""];
32->13 [style = solid, label="ndocs"];
6->26 [style = bold, label=""];
40->23 [style = bold, label=""];
5->33 [style = solid, label="i"];
49->45 [style = solid, label="thread"];
43->41 [style = solid, label="i"];
41->49 [style = solid, label="i"];
32->15 [style = solid, label="ndocs"];
21->3 [style = dotted, label="true"];
34->35 [style = solid, label="nWriteThreads"];
34->36 [style = bold, label=""];
26->33 [style = bold, label=""];
31->44 [style = solid, label="nReadThreads"];
31->12 [style = bold, label=""];
5->26 [style = solid, label="i"];
8->38 [style = bold, label=""];
56->60 [style = bold, label=""];
21->59 [style = dotted, label="true"];
2->3 [style = solid, label="deletePercent"];
31->51 [style = solid, label="nReadThreads"];
44->41 [style = dotted, label="true"];
17->37 [style = bold, label=""];
32->33 [style = solid, label="ndocs"];
22->18 [style = bold, label=""];
26->33 [style = dotted, label="true"];
3->48 [style = bold, label=""];
20->24 [style = bold, label=""];
24->19 [style = bold, label=""];
16->30 [style = bold, label=""];
52->53 [style = solid, label="i"];
32->3 [style = solid, label="ndocs"];
28->55 [style = dashed, label="0"];
9->5 [style = bold, label=""];
28->33 [style = solid, label="percentRealtimeQuery"];
30->21 [style = solid, label="i"];
41->44 [style = solid, label="i"];
28->4 [style = solid, label="percentRealtimeQuery"];
57->40 [style = bold, label=""];
39->14 [style = solid, label="deleteByQueryPercent"];
30->11 [style = solid, label="i"];
2->57 [style = bold, label=""];
11->3 [style = solid, label="i"];
50->38 [style = bold, label=""];
11->21 [style = bold, label=""];
51->54 [style = dotted, label="true"];
36->55 [style = bold, label=""];
10->31 [style = bold, label=""];
51->53 [style = bold, label=""];
3->25 [style = solid, label="thread"];
46->42 [style = bold, label=""];
10->18 [style = solid, label="operations"];
5->26 [style = bold, label=""];
25->11 [style = bold, label=""];
24->12 [style = solid, label="commitPercent"];
34->36 [style = solid, label="nWriteThreads"];
39->3 [style = solid, label="deleteByQueryPercent"];
30->3 [style = solid, label="i"];
48->11 [style = bold, label=""];
36->3 [style = solid, label="maxConcurrentCommits"];
59->11 [style = bold, label=""];
58->51 [style = bold, label=""];
52->58 [style = solid, label="i"];
39->40 [style = bold, label=""];
19->3 [style = solid, label="softCommitPercent"];
38->20 [style = bold, label=""];
43->49 [style = solid, label="i"];
52->51 [style = solid, label="i"];
31->1 [style = solid, label="nReadThreads"];
58->53 [style = solid, label="i"];
2->29 [style = solid, label="deletePercent"];
}
