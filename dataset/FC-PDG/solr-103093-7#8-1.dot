digraph {
24 [style = filled, label = "clearIndex()@@@3@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
5 [style = filled, label = "i++@@@117@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
30 [style = filled, label = "testStressReorderVersions['0', '1', '0']", fillcolor = lightgray, shape = diamond image = "AAA0AAABBB2BBB"];
36 [style = filled, label = "int i = 0@@@135@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
22 [style = filled, label = "threads.add(thread)@@@188@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
17 [style = filled, label = "final AtomicInteger numCommitting = new AtomicInteger()@@@17@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
23 [style = filled, label = "final int deletePercent = 4 + random().nextInt(25)@@@7@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
28 [style = filled, label = "int nReadThreads = 5 + random().nextInt(25)@@@14@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
18 [style = filled, label = "assertU(commit())@@@4@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
1 [style = filled, label = "final int softCommitPercent = 30 + random().nextInt(75)@@@6@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
31 [style = filled, label = "thread.join()@@@194@@@['0', '0', '1']", fillcolor = lightgray, shape = ellipse image = "AAA0AAABBB3BBB"];
15 [style = filled, label = "verbose(\"commitPercent\",commitPercent,\"softCommitPercent\",softCommitPercent,\"deletePercent\",deletePercent,\"deleteByQueryPercent\",deleteByQueryPercent,\"ndocs\",ndocs,\"nWriteThreads\",nWriteThreads,\"percentRealtimeQuery\",percentRealtimeQuery,\"operations\",operations,\"nReadThreads\",nReadThreads)@@@15@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
12 [style = filled, label = "i < nReadThreads@@@116@@@['1', '1', '0']", fillcolor = white, shape = diamond image = "AAA0AAABBB1BBB"];
19 [style = filled, label = "final int percentRealtimeQuery = 75@@@12@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
35 [style = filled, label = "testStressReorderVersions['0', '0', '1']", fillcolor = lightgray, shape = diamond image = "AAA0AAABBB3BBB"];
16 [style = filled, label = "thread.start()@@@181@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
26 [style = filled, label = "threads.add(thread)@@@113@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
25 [style = filled, label = "int nWriteThreads = 5 + random().nextInt(25)@@@10@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
32 [style = filled, label = "thread.start()@@@191@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
21 [style = filled, label = "i < nWriteThreads@@@21@@@['1', '1', '1']", fillcolor = white, shape = diamond image = "AAA0AAABBB1BBB"];
6 [style = filled, label = "final AtomicLong testVersion = new AtomicLong(0)@@@19@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
29 [style = filled, label = "final int maxConcurrentCommits = nWriteThreads@@@11@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
2 [style = filled, label = "final AtomicLong operations = new AtomicLong(10000)@@@13@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
0 [style = filled, label = "int i = 0@@@20@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
27 [style = filled, label = "int i = 0@@@115@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
38 [style = filled, label = "i < nReadThreads@@@136@@@['0', '0', '1']", fillcolor = white, shape = diamond image = "AAA0AAABBB3BBB"];
9 [style = filled, label = "Thread thread = new Thread(\"READER\" + i){@Override public void run(){try {while (operations.decrementAndGet() >= 0) {int id = rand.nextInt(100) < 25? lastId: rand.nextInt(ndocs)boolean realTime = rand.nextInt(100) < percentRealtimeQueryDocInfo infoif (realTime) {info = model.get(id)}{synchronized (this) {info = committedModel.get(id)}}if (VERBOSE) {verbose(\"querying id\",id)}SolrQueryRequest sreqif (realTime) {sreq = req(\"wt\",\"json\",\"qt\",\"/get\",\"ids\",Integer.toString(id))}{sreq = req(\"wt\",\"json\",\"q\",\"id:\" + Integer.toString(id),\"omitHeader\",\"true\")}String response = h.query(sreq)Map rsp = (Map)Utils.fromJSONString(response)List doclist = (List)(((Map)rsp.get(\"response\")).get(\"docs\"))if (doclist.size() == 0) {}{assertEquals(1,doclist.size())boolean isLive = (Boolean)(((Map)doclist.get(0)).get(lfield))long foundVer = (Long)(((Map)doclist.get(0)).get(vfield))if (isLive) {long foundVal = (Long)(((Map)doclist.get(0)).get(FIELD))if (foundVer < Math.abs(info.version) || (foundVer == info.version && foundVal != info.val)) {log.error(\"ERROR, id=\" + id + \" found=\" + response + \" model\" + info)assertTrue(false)}}{assertNull(((Map)doclist.get(0)).get(FIELD))if (foundVer < Math.abs(info.version)) {log.error(\"ERROR, id=\" + id + \" found=\" + response + \" model\" + info)assertTrue(false)}}}}}catch (Throwable e) }}@@@118@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
39 [style = filled, label = "threads.add(thread)@@@133@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
37 [style = filled, label = "i++@@@137@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
3 [style = filled, label = "Thread thread = new Thread(\"WRITER\" + i){@Override public void run(){try {while (operations.get() > 0) {int oper = rand.nextInt(100)if (oper < commitPercent) {if (numCommitting.incrementAndGet() <= maxConcurrentCommits) {Map<Integer,DocInfo> newCommittedModellong versionsynchronized (this) {newCommittedModel = new HashMap<>(model)version = snapshotCount++}if (rand.nextInt(100) < softCommitPercent) {verbose(\"softCommit start\")assertU(TestHarness.commit(\"softCommit\",\"true\"))verbose(\"softCommit end\")}{verbose(\"hardCommit start\")assertU(commit())verbose(\"hardCommit end\")}synchronized (this) {if (version >= committedModelClock) {if (VERBOSE) {verbose(\"installing new committedModel version=\" + committedModelClock)}committedModel = newCommittedModelcommittedModelClock = version}}}numCommitting.decrementAndGet()continue}int idif (rand.nextBoolean()) {id = rand.nextInt(ndocs)}{id = lastId}boolean before = rand.nextBoolean()if (before) {lastId = id}DocInfo info = model.get(id)long val = info.vallong nextVal = Math.abs(val) + 1long version = testVersion.incrementAndGet()if (rand.nextBoolean()) Thread.yield()if (oper < commitPercent + deletePercent) {verbose(\"deleting id\",id,\"val=\",nextVal,\"version\",version)Long returnedVersion = deleteAndGetVersion(Integer.toString(id),params(\"_version_\",Long.toString(-version),DISTRIB_UPDATE_PARAM,FROM_LEADER))if (returnedVersion != null) {assertEquals(-version,returnedVersion.longValue())}synchronized (model) {DocInfo currInfo = model.get(id)if (Math.abs(version) > Math.abs(currInfo.version)) {model.put(id,new DocInfo(version,-nextVal))}}verbose(\"deleting id\",id,\"val=\",nextVal,\"version\",version,\"DONE\")}if (oper < commitPercent + deletePercent + deleteByQueryPercent) {verbose(\"deleteByQuery id\",id,\"val=\",nextVal,\"version\",version)Long returnedVersion = deleteByQueryAndGetVersion(\"id:\" + Integer.toString(id),params(\"_version_\",Long.toString(-version),DISTRIB_UPDATE_PARAM,FROM_LEADER))if (returnedVersion != null) {assertEquals(-version,returnedVersion.longValue())}synchronized (model) {DocInfo currInfo = model.get(id)if (Math.abs(version) > Math.abs(currInfo.version)) {model.put(id,new DocInfo(version,-nextVal))}}verbose(\"deleteByQuery id\",id,\"val=\",nextVal,\"version\",version,\"DONE\")}{verbose(\"adding id\",id,\"val=\",nextVal,\"version\",version)Long returnedVersion = addAndGetVersion(sdoc(\"id\",Integer.toString(id),FIELD,Long.toString(nextVal),\"_version_\",Long.toString(version)),params(DISTRIB_UPDATE_PARAM,FROM_LEADER))if (returnedVersion != null) {assertEquals(version,returnedVersion.longValue())}synchronized (model) {DocInfo currInfo = model.get(id)if (version > currInfo.version) {model.put(id,new DocInfo(version,nextVal))}}if (VERBOSE) {verbose(\"adding id\",id,\"val=\",nextVal,\"version\",version,\"DONE\")}}if (!before) {lastId = id}}}catch (Throwable e) }}@@@23@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
33 [style = filled, label = "Thread thread = new Thread(\"READER\" + i){@Override public void run(){try {while (operations.decrementAndGet() >= 0) {int id = rand.nextInt(100) < 25? lastId: rand.nextInt(ndocs)boolean realTime = rand.nextInt(100) < percentRealtimeQueryDocInfo infoif (realTime) {info = model.get(id)}{synchronized (this) {info = committedModel.get(id)}}if (VERBOSE) {verbose(\"querying id\",id)}SolrQueryRequest sreqif (realTime) {sreq = req(\"wt\",\"json\",\"qt\",\"/get\",\"ids\",Integer.toString(id))}{sreq = req(\"wt\",\"json\",\"q\",\"id:\" + Integer.toString(id),\"omitHeader\",\"true\")}String response = h.query(sreq)Map rsp = (Map)ObjectBuilder.fromJSON(response)List doclist = (List)(((Map)rsp.get(\"response\")).get(\"docs\"))if (doclist.size() == 0) {}{assertEquals(1,doclist.size())long foundVal = (Long)(((Map)doclist.get(0)).get(FIELD))long foundVer = (Long)(((Map)doclist.get(0)).get(\"_version_\"))if (foundVer < Math.abs(info.version) || (foundVer == info.version && foundVal != info.val)) {log.error(\"ERROR, id=\" + id + \" found=\" + response + \" model\" + info)assertTrue(false)}}}}catch (Throwable e) }}@@@138@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
7 [style = filled, label = "testStressReorderVersions['1', '0', '0']", fillcolor = lightgray, shape = diamond image = "AAA0AAABBB1BBB"];
4 [style = filled, label = "List<Thread> threads = new ArrayList<>()@@@18@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
10 [style = filled, label = "final int ndocs = 5 + (random().nextBoolean()? random().nextInt(25): random().nextInt(200))@@@9@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
13 [style = filled, label = "threads.add(thread)@@@178@@@['1', '1', '0']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
20 [style = filled, label = "initModel(ndocs)@@@16@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
8 [style = filled, label = "final int deleteByQueryPercent = random().nextInt(8)@@@8@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
11 [style = filled, label = "i++@@@22@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
14 [style = filled, label = "final int commitPercent = 5 + random().nextInt(20)@@@5@@@['1', '1', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB1BBB"];
34 [style = filled, label = "final AtomicLong operations = new AtomicLong(50000)@@@13@@@['0', '0', '1']", fillcolor = white, shape = ellipse image = "AAA0AAABBB3BBB"];
8->10 [style = bold, label=""];
21->11 [style = dotted, label="true"];
19->33 [style = solid, label="percentRealtimeQuery"];
22->37 [style = bold, label=""];
25->29 [style = bold, label=""];
29->3 [style = solid, label="maxConcurrentCommits"];
28->15 [style = solid, label="nReadThreads"];
12->9 [style = bold, label=""];
26->11 [style = bold, label=""];
37->33 [style = solid, label="i"];
1->23 [style = bold, label=""];
1->3 [style = solid, label="softCommitPercent"];
33->22 [style = solid, label="thread"];
23->15 [style = solid, label="deletePercent"];
27->5 [style = solid, label="i"];
21->36 [style = bold, label=""];
21->26 [style = dotted, label="true"];
27->9 [style = solid, label="i"];
15->20 [style = bold, label=""];
37->38 [style = bold, label=""];
21->39 [style = dotted, label="true"];
14->3 [style = solid, label="commitPercent"];
9->13 [style = bold, label=""];
3->39 [style = bold, label=""];
0->21 [style = solid, label="i"];
2->28 [style = bold, label=""];
38->33 [style = dotted, label="true"];
21->3 [style = bold, label=""];
5->9 [style = solid, label="i"];
25->15 [style = solid, label="nWriteThreads"];
19->34 [style = bold, label=""];
27->12 [style = bold, label=""];
3->26 [style = solid, label="thread"];
37->38 [style = solid, label="i"];
11->3 [style = solid, label="i"];
0->21 [style = bold, label=""];
19->2 [style = bold, label=""];
10->33 [style = solid, label="ndocs"];
23->8 [style = bold, label=""];
24->18 [style = bold, label=""];
36->37 [style = solid, label="i"];
38->32 [style = bold, label=""];
7->24 [style = bold, label=""];
10->9 [style = solid, label="ndocs"];
10->25 [style = bold, label=""];
13->5 [style = bold, label=""];
36->38 [style = solid, label="i"];
38->33 [style = bold, label=""];
32->31 [style = bold, label=""];
11->21 [style = solid, label="i"];
19->15 [style = solid, label="percentRealtimeQuery"];
38->37 [style = dotted, label="true"];
30->24 [style = bold, label=""];
21->27 [style = bold, label=""];
23->3 [style = solid, label="deletePercent"];
11->21 [style = bold, label=""];
3->26 [style = bold, label=""];
38->22 [style = dotted, label="true"];
34->15 [style = solid, label="operations"];
10->3 [style = solid, label="ndocs"];
9->13 [style = solid, label="thread"];
35->24 [style = bold, label=""];
25->29 [style = solid, label="nWriteThreads"];
34->28 [style = bold, label=""];
8->15 [style = solid, label="deleteByQueryPercent"];
12->13 [style = dotted, label="true"];
29->19 [style = bold, label=""];
0->3 [style = solid, label="i"];
21->3 [style = dotted, label="true"];
10->15 [style = solid, label="ndocs"];
5->12 [style = solid, label="i"];
19->9 [style = solid, label="percentRealtimeQuery"];
36->33 [style = solid, label="i"];
17->4 [style = bold, label=""];
33->22 [style = bold, label=""];
10->20 [style = solid, label="ndocs"];
1->15 [style = solid, label="softCommitPercent"];
20->17 [style = bold, label=""];
28->15 [style = bold, label=""];
4->6 [style = bold, label=""];
25->21 [style = solid, label="nWriteThreads"];
6->0 [style = bold, label=""];
12->16 [style = bold, label=""];
16->22 [style = bold, label=""];
39->11 [style = bold, label=""];
28->12 [style = solid, label="nReadThreads"];
14->1 [style = bold, label=""];
28->38 [style = solid, label="nReadThreads"];
2->15 [style = solid, label="operations"];
5->12 [style = bold, label=""];
12->5 [style = dotted, label="true"];
8->3 [style = solid, label="deleteByQueryPercent"];
14->15 [style = solid, label="commitPercent"];
0->11 [style = solid, label="i"];
2->34 [style = dashed, label="0"];
3->39 [style = solid, label="thread"];
36->38 [style = bold, label=""];
12->9 [style = dotted, label="true"];
18->14 [style = bold, label=""];
27->12 [style = solid, label="i"];
}
